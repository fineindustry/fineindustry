import streamlit as st
import pandas as pd
import re
import math
from collections import defaultdict

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ê²¬ì  ìš”ì²­ ìë™ ìƒì„±ê¸°", page_icon="ğŸ“„")
st.title("ğŸ“„ ì‹œíŠ¸íŒ + íŒŒì´í”„ + Cí˜•ê°•/ã„·í˜•ê°• ê²¬ì  ìš”ì²­ ìë™ ìƒì„±")
st.markdown("í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ìœ„(EA ë˜ëŠ” kg)ë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²¬ì  ìš”ì²­ ë¬¸ì¥ì´ ìƒì„±ë©ë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) Cí˜•ê°• / ã„·í˜•ê°• ë¬´ê²Œí‘œ (10m ê¸°ì¤€, kg)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
weights = {
    "Cí˜•ê°•": {
        "60Ã—30Ã—10Ã—1.6": 16.3,
        "60Ã—30Ã—10Ã—2.0": 19.9,
        "60Ã—30Ã—10Ã—2.3": 22.5,
        "75Ã—45Ã—15Ã—1.6": 23.2,
        "75Ã—45Ã—15Ã—2.0": 28.6,
        "75Ã—45Ã—15Ã—2.3": 32.5,
        "75Ã—45Ã—20Ã—2.0": 35.6,
        "75Ã—45Ã—20Ã—2.3": 40.6,
        "100Ã—50Ã—20Ã—1.6": 28.8,
        "100Ã—50Ã—20Ã—2.0": 35.6,
        "100Ã—50Ã—20Ã—2.3": 40.6,
        "100Ã—50Ã—20Ã—2.6": 45.5,
        "100Ã—50Ã—20Ã—3.2": 55.0,
        "125Ã—50Ã—20Ã—2.0": 39.5,
        "125Ã—50Ã—20Ã—2.3": 45.1,
        "125Ã—50Ã—20Ã—3.2": 61.3,
        "150Ã—50Ã—20Ã—3.2": 67.6,
        "150Ã—65Ã—20Ã—3.2": 75.1,
        "150Ã—65Ã—20Ã—4.0": 92.2,
        "150Ã—65Ã—20Ã—4.5": 103.0,
        "150Ã—75Ã—20Ã—3.2": 82.7,
        "200Ã—75Ã—20Ã—3.2": 92.7,
        "200Ã—75Ã—20Ã—4.0": 127.0,
        "200Ã—75Ã—20Ã—4.5": 140.0,
        "200Ã—75Ã—25Ã—3.2": 95.2,
        "200Ã—75Ã—25Ã—4.0": 117.0,
        "200Ã—75Ã—25Ã—4.5": 131.0,
        "200Ã—80Ã—20Ã—4.0": 133.0,
        "200Ã—80Ã—20Ã—4.5": 149.0
    },
    "ã„·í˜•ê°•": {
        "75Ã—40 (5.0/7.0)": 69.2,
        "100Ã—50 (5.0/7.5)": 93.6,
        "125Ã—65 (6.0/8.0)": 134.0,
        "150Ã—75 (6.5/10.0)": 186.0,
        "150Ã—75 (9.0/12.5)": 240.0,
        "200Ã—80 (7.5/11.0)": 246.0,
        "200Ã—90 (8.0/13.5)": 303.0,
        "250Ã—90 (9.0/13.0)": 346.0,
        "250Ã—90 (11.0/14.5)": 402.0,
        "300Ã—90 (9.0/13.0)": 381.0,
        "300Ã—90 (10.0/15.5)": 438.0,
        "300Ã—90 (12.0/16.0)": 486.0,
        "380Ã—100 (10.5/16.0)": 545.0,
        "380Ã—100 (13.0/16.5)": 620.0,
        "380Ã—100 (13.0/20.0)": 673.0
    }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ìŠ¤í™ ì¶”ì¶œ í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def extract_spec(name: str, form: str) -> str:
    # ê³µë°± ì œê±° Â· ëŒ€ë¬¸ì í†µì¼ Â· ascii x, X, * â†’ ìœ ë‹ˆì½”ë“œ Ã— ë¡œ ì¹˜í™˜
    nm = name.upper().replace(" ", "")
    nm = nm.replace("X", "Ã—").replace("x", "Ã—").replace("*", "Ã—")

    if form == "Cí˜•ê°•":
        m = re.search(
            r"(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[tT]?",
            nm
        )
        if m:
            return f"{m.group(1)}Ã—{m.group(2)}Ã—{m.group(3)}Ã—{m.group(4)}"

    elif form == "ã„·í˜•ê°•":
        # â”€â”€ â‘  ê´„í˜¸ ì—†ëŠ” ë„¤ ìˆ«ì (ì˜ˆ: 100Ã—50Ã—5Ã—7.5t) â”€â”€
        tmp = re.sub(r"[tT]", "", nm)
        m1 = re.search(
            r"(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)",
            tmp
        )
        if m1:
            d1, d2, v1, v2 = m1.groups()
            return f"{d1}Ã—{d2} ({float(v1):.1f}/{float(v2):.1f})"

        # â”€â”€ â‘¡ ê¸°ì¡´ ê´„í˜¸+ìŠ¬ë˜ì‹œ íŒ¨í„´ â”€â”€
        m2 = re.search(
            r"(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[(](\d+(?:\.\d+)?)/(\d+(?:\.\d+)?)[)]",
            nm
        )
        if m2:
            return f"{m2.group(1)}Ã—{m2.group(2)} ({float(m2.group(3)):.1f}/{float(m2.group(4)):.1f})"

    elif form == "ì›í˜•íŒŒì´í”„":
        m = re.search(
            r"Ã˜?(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)[tT]?",
            nm
        )
        if m:
            return f"Ã˜{m.group(1)}Ã—{m.group(2)}"

    elif form == "ê°íŒŒì´í”„":
        m = re.search(
            r"(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)(?:[Ã—](\d+(?:\.\d+)?))?",
            nm
        )
        if m:
            parts = [m.group(1), m.group(2)]
            if m.group(3):
                parts.append(m.group(3))
            return "Ã—".join(parts)

    # ì‹œíŠ¸íŒ íŒ¨í„´ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ì²˜ë¦¬
    return None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ì¤‘ëŸ‰ ê³„ì‚° ë³´ì¡° í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def calc_round_pipe_weight(d_mm: float, t_mm: float, length_mm: float) -> float:
    density = 7.85e-6
    id_mm = d_mm - 2 * t_mm
    if id_mm <= 0:
        return 0.0
    cross = math.pi/4 * (d_mm**2 - id_mm**2)
    return round(cross * length_mm * density, 2)

def calc_rect_pipe_weight(w_mm: float, h_mm: float, t_mm: float, length_mm: float) -> float:
    density = 7.85e-6
    inner_w = w_mm - 2 * t_mm
    inner_h = h_mm - 2 * t_mm
    if inner_w <= 0 or inner_h <= 0:
        return 0.0
    cross = (w_mm * h_mm) - (inner_w * inner_h)
    return round(cross * length_mm * density, 2)

def extract_dimensions(name: str):
    # â‘  ê³µë°± ì œê±° Â· ëŒ€ë¬¸ì í†µì¼
    nm = name.upper().replace(" ", "")
    # â‘¡ ascii x/X/* ë¬¸ìë¥¼ ìœ ë‹ˆì½”ë“œ Ã— ë¡œ í†µì¼
    nm = nm.replace("X", "Ã—").replace("x", "Ã—").replace("*", "Ã—")

    # â‘¢ 'TÃ—í­Ã—ê¸¸ì´' íŒ¨í„´ ë§¤ì¹­
    m = re.search(r"(\d+(?:\.\d+)?)TÃ—(\d+(?:\.\d+)?)[Ã—](\d+(?:\.\d+)?)", nm)
    if m:
        return float(m.group(1)), float(m.group(2)), float(m.group(3))
    return None, None, None


def calc_sheet_weight(t: float, w: float, l: float) -> float:
    return round(t * w * l * 7.85 / 1_000_000, 2)

def calculate_weight(form: str, spec: str) -> float:
    # â‘  í…Œì´ë¸” ìš°ì„ 
    if form in weights and spec in weights[form]:
        return weights[form][spec]
    # â‘¡ ì›í˜•íŒŒì´í”„ (6m)
    if form == "ì›í˜•íŒŒì´í”„" and spec:
        d, t = map(float, spec.replace("Ã˜", "").split("Ã—"))
        return calc_round_pipe_weight(d, t, 6000)
    # â‘¢ ê°íŒŒì´í”„ (6m)
    if form == "ê°íŒŒì´í”„" and spec:
        parts = list(map(float, spec.split("Ã—")))
        return calc_rect_pipe_weight(parts[0], parts[1], parts[2] if len(parts) > 2 else 0, 6000)
    return None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ë¶„ë¥˜ & ê³µê¸‰ì²˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def classify_form(name: str) -> str:
    nm = name.upper()
    if "Cí˜•ê°•" in nm:
        return "Cí˜•ê°•"
    if "ã„·í˜•ê°•" in nm:
        return "ã„·í˜•ê°•"
    if any(k in nm for k in ["ê°íŒŒì´í”„", "ê°ê´€"]):
        return "ê°íŒŒì´í”„"
    if any(k in nm for k in ["ì›í˜•íŒŒì´í”„", "Ã˜"]):
        return "ì›í˜•íŒŒì´í”„"
    if "ì‹œíŠ¸íŒ" in nm:
        return "ì‹œíŠ¸íŒ"
    return "ê¸°íƒ€"

def classify_type(name: str) -> str:
    nm = name.upper()
    if "HR" in nm or "HGI" in nm:
        return "HR"
    if "CR" in nm or "EGI" in nm:
        return "CR"
    return "ê¸°íƒ€"

def get_vendors(form: str, mat: str, name: str) -> list:
    s = name.replace("x", "Ã—").upper()
    if form in ["ê°íŒŒì´í”„", "ì›í˜•íŒŒì´í”„"] and any(x in s for x in ["27Ã—70", "70Ã—27"]):
        return ["ê²½ì•ˆíŒŒì´í”„"]
    if form in ["Cí˜•ê°•", "ã„·í˜•ê°•"]:
        v = ["ë°±ì‚°ì² ê°•", "íƒœê°•ìŠ¤í‹¸"]
        if mat == "HR":
            v.append("ìœ ë¯¼ì² ê°•")
        return v
    if form in ["ê°íŒŒì´í”„", "ì›í˜•íŒŒì´í”„"]:
        v = ["ë°±ì‚°ì² ê°•", "íƒœê°•ìŠ¤í‹¸"]
        if mat == "HR":
            v.append("ìœ ë¯¼ì² ê°•")
        return v
    if form == "ì‹œíŠ¸íŒ":
        return (["ë¬¸ë°°ì² ê°•", "íƒœì°½ì² ê°•", "ì§€ì˜¤ìŠ¤í‹¸", "ê²½ë¶ì½”ì¼ì„¼í„°", "ì‹ ì˜ìŠ¤í‹¸", "ì„±ì£¼ì—ìŠ¤í‹°"]
                if mat == "HR"
                else ["ê¸ˆê°•ì² ê°•", "ì°½í™”ì² ê°•", "ê¸°ë³´ìŠ¤í‹¸", "ì˜ì§„ì² ê°•", "ì• ë‹ˆìŠ¤í‹¸"])
    return []

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) DataEditor ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sample = pd.DataFrame({
    "í’ˆëª…": [
        "150Ã—75Ã—20Ã—3.2 Cí˜•ê°•", "Ã˜25.4Ã—2.3 ì›í˜•íŒŒì´í”„",
        "ì‹œíŠ¸íŒ 1.0TÃ—1220Ã—2440 CR", "CR 1.2T ì½”ì¼",
        "100x50x5x7.5t ã„·í˜•ê°•"
    ],
    "ìˆ˜ëŸ‰": [10, 300, 10, 500, 4],
    "ë‹¨ìœ„": ["ea", "kg", "ea", "kg", "ea"]
})

edited = st.data_editor(
    sample,
    num_rows="dynamic",
    use_container_width=True,
    column_config={
        "ë‹¨ìœ„": st.column_config.SelectboxColumn(
            label="ë‹¨ìœ„",
            options=["ea", "kg"]
        )
    }
)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) ê³„ì‚° & ê·¸ë£¹í•‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vendor_to_items = defaultdict(list)
item_to_text = {}

for _, row in edited.iterrows():
    name = str(row["í’ˆëª…"]).strip()
    if not name:
        continue

    qty_raw, unit_raw = row["ìˆ˜ëŸ‰"], row["ë‹¨ìœ„"]
    if pd.isna(qty_raw) or pd.isna(unit_raw):
        continue
    unit = str(unit_raw).lower()
    if unit not in ("ea", "kg"):
        continue
    try:
        qty = float(qty_raw)
    except:
        continue

    form = classify_form(name)
    mat  = classify_type(name)
    spec = extract_spec(name, form)
    wt   = 0.0

    if form == "ì‹œíŠ¸íŒ":
        t, w, l = extract_dimensions(name)
        if t and w and l:
            wt = calc_sheet_weight(t, w, l)
            if unit == "kg":
                total = qty
                pcs = int(round(total / wt)) if wt else 0
            else:
                pcs = int(qty)
                total = round(pcs * wt, 2)
        else:
            pcs, total = 0, 0.0
    else:
        w_calc = calculate_weight(form, spec)
        if w_calc is not None:
            wt = w_calc
            if unit == "kg":
                total = qty
                pcs = int(round(total / wt)) if wt else 0
            else:
                pcs = int(qty)
                total = round(pcs * wt, 2)
        else:
            st.warning(f"'{name}'ì˜ ì¤‘ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            pcs, total = 0, 0.0

    item_to_text[name] = f"{name} {pcs}EA (ì´ {total}kg)"
    for v in get_vendors(form, mat, name):
        vendor_to_items[v].append(name)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ì¶œë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grouped = defaultdict(list)
for v, items in vendor_to_items.items():
    key = tuple(sorted(set(items)))
    grouped[key].append(v)

for i, (item_grp, vend_list) in enumerate(grouped.items()):
    st.subheader(f"ğŸ“¨ ê²¬ì  ìš”ì²­ - {', '.join(vend_list)}")
    lines = [item_to_text[x] for x in item_grp]
    msg   = "ì•ˆë…•í•˜ì„¸ìš”.\n" + "\n".join(lines) + "\nì¬ê³  ë° ê²¬ì  ìš”ì²­ë“œë¦½ë‹ˆë‹¤."
    st.text_area("ê²¬ì  ìš”ì²­ ë‚´ìš©", msg, height=200, key=f"msg_{i}")
